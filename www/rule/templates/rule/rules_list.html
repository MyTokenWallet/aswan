{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load crispy_forms_tags %}
{% load staticfiles %}


{% block css %}
{{ block.super }}
<style>
    .action-button {
        margin-right: 20px;
    }
</style>
{% endblock %}


{% block header %}
<a href="javascript:;" class="active">Rule configuration</a>
{% endblock %}


{% block action %}
<a class="roll-nav roll-right extra-right-btns pull-right" href="{% url 'rule:test' %}">
    <i class="fa fa-cog"></i>
    调试
</a>
<a class="roll-nav roll-right extra-right-btns pull-right" href="{% url 'rule:create' %}">
    <i class="fa fa-plus"></i>
    Add
</a>
{% endblock %}


{% block main %}
<div class="wrapper wrapper-content">
    <div class="extra-search-form">
        {% crispy filter_form %}
    </div>
    <div class="extra-box-content">
        {% render_table table "table.html" %}
    </div>
</div>

<div class="modal inmodal fade" id="show-detail" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h2>规则详情</h2>
            </div>
            <div class="modal-body">
                <label class="form-control control-label" id="detail-title"></label>
                <div class="hr-line-dashed"></div>
                <label class="form-control control-label" id="detail-describe"></label>
                <div class="hr-line-dashed"></div>
                <label class="form-control control-label" id="detail-status"></label>
                <div class="hr-line-dashed"></div>
                <label class="form-control control-label" id="detail-end_time"></label>
                <div class="hr-line-dashed"></div>
                <ul id="detail-list">
                    <li style="display: none;">
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block js %}
{{ block.super }}

<script>
    $(function () {
        $('.rules-destroy').click(function () {
            var _this = $(this),
                uri = _this.data('uri'),
                id = _this.data('id');
            swal({
                title: "Are you sure you want to delete it",
                type: "warning",
                allowOutsideClick: true,
                showCancelButton: true,
                confirmButtonColor: "#ff6700",
                confirmButtonText: "delete",
                cancelButtonText: "cancel",
                closeOnConfirm: true
            }, function () {
                $.ajax({
                    url: uri,
                    data: {
                        'id': id,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    dataType: "json",
                    type: "POST",
                    success: function (resp) {
                        if (resp.state) {
                            window.location.reload();
                        }
                    },
                    error: function (err) {
                        if (err.statusText !== 'abort') {
                            swal({
                                title: "failed to delete",
                                type: "error",
                                confirmButtonColor: "#ff6700"
                            });
                        }
                    }
                })
            });
        });
    });
    $(function () {
        $('.rules-on').click(function () {
            var _this = $(this),
                uri = _this.data('uri'),
                title = _this.data('title'),
                status = _this.data('status'),
                id = _this.data('id');
            if (status === 'on') {
                swal({
                    title: "Rules" + title + "already enabled",
                    type: "error",
                    confirmButtonColor: "#ff6700"
                });
                return;
            }
            swal({
                title: "You determine the Enable rule" + title + "Do you?",
                type: "warning",
                allowOutsideClick: true,
                showCancelButton: true,
                confirmButtonColor: "#ff6700",
                confirmButtonText: "Enable",
                cancelButtonText: "cancel",
                closeOnConfirm: true
            }, function () {
                $.ajax({
                    url: uri,
                    data: {'id': id, 'status': status},
                    dataType: "json",
                    type: "POST",
                    success: function (resp) {
                        if (resp.state) {
                            window.location.reload();
                        }
                    },
                    error: function (err) {
                        if (err.statusText !== 'abort') {
                            swal({
                                title: "Enable failed",
                                type: "error",
                                confirmButtonColor: "#ff6700"
                            });
                        }
                    }
                })
            });
        });
    });

    $(function () {
        $('.rules-off').click(function () {
            var _this = $(this),
                uri = _this.data('uri'),
                title = _this.data('title'),
                status = _this.data('status'),
                id = _this.data('id');
            if (status === 'off') {
                swal({
                    title: "Rules" + title + "already disabled",
                    type: "error",
                    confirmButtonColor: "#ff6700"
                });
                return;
            }
            swal({
                title: "You determine the Disable rule" + title + "Do you?",
                type: "warning",
                allowOutsideClick: true,
                showCancelButton: true,
                confirmButtonColor: "#ff6700",
                confirmButtonText: "Disable",
                cancelButtonText: "cancel",
                closeOnConfirm: true
            }, function () {
                $.ajax({
                    url: uri,
                    data: {'id': id, 'status': status},
                    dataType: "json",
                    type: "POST",
                    success: function (resp) {
                        if (resp.state) {
                            window.location.reload();
                        }
                    },
                    error: function (err) {
                        if (err.statusText !== 'abort') {
                            swal({
                                title: "Disable failed",
                                type: "error",
                                confirmButtonColor: "#ff6700"
                            });
                        }
                    }
                })
            });
        });
    });

    $(function () {
        $('.rules-detail').click(function () {
            var _this = $(this),
                uri = _this.data('uri'),
                id = _this.data('id'),
                url = uri + "?id=" + id;
            window.location.href = url;
        });
    });

    $(function () {
        $('.rules-edit').click(function () {
            var _this = $(this),
                uri = _this.data('uri'),
                id = _this.data('id'),
                url = uri + "?id=" + id;
            window.location.href = url;
        });
    });

    $(function () {
        $('td .rules-on').map(function () {
            if ($(this).attr("data-status") == "on") {
                $(this).parent().attr("hidden", "");
            }
        });
        $('td .rules-off').map(function () {
            if ($(this).attr("data-status") == "off") {
                $(this).parent().attr("hidden", "");
            }
        });
    });

    $(function () {
        $('th.id').click(function () {
            var _this = $(this),
                new_uri = '';
            var uri = _this.find('a').attr('href');
            var target = window.location.href.substr(window.location.href.indexOf("?"));
            if (target.indexOf('sort=id') < 0) {
                new_uri = uri.replace("sort=-id", "sort=id");
                _this.find('a').attr('href', new_uri);
            } else {
                new_uri = uri.replace("sort=id", "sort=-id");
                _this.find('a').attr('href', new_uri);
            }
        });
    })
</script>
{% endblock %}
